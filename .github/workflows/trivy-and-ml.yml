name: trivy-and-ml

on:
  push:
    branches: [ main, hybrid_operator ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      mode:
        description: "pipeline = normal Trivy+ML run; sv_trivy = repeated Trivy validation + summary CSV; sv_ml = ML K-fold CV validation + summary CSV; sv_gate = full hybrid decision validation (Trivy+ML+Gate) + summary CSV; sv_gitleaks = Gitleaks validation + summary CSV (tool comparison)"
        required: true
        default: "pipeline"

      # --- sv_trivy inputs ---
      runs:
        description: "Runs per profile for sv_trivy"
        required: false
        default: "10"
      profiles:
        description: "Profiles for sv_trivy (comma-separated)"
        required: false
        default: "low,medium,high"

      # --- sv_ml inputs ---
      ml_folds:
        description: "K folds for sv_ml"
        required: false
        default: "5"
      ml_seeds:
        description: "Seeds for sv_ml (comma-separated)"
        required: false
        default: "42,43,44"
      ml_contam:
        description: "Contamination for sv_ml (Isolation Forest)"
        required: false
        default: "0.05"

      # --- sv_gate inputs ---
      gate_runs:
        description: "Runs per profile for sv_gate"
        required: false
        default: "10"
      gate_profiles:
        description: "Profiles for sv_gate (comma-separated)"
        required: false
        default: "clean,low,medium,high"
      gate_ml_contam:
        description: "ML contamination for sv_gate"
        required: false
        default: "0.005"

      # --- sv_gitleaks inputs (NEW) ---
      gitleaks_runs:
        description: "Runs per profile for sv_gitleaks"
        required: false
        default: "10"
      gitleaks_profiles:
        description: "Profiles for sv_gitleaks (comma-separated)"
        required: false
        default: "clean,low,medium,high"
      gitleaks_version:
        description: "Gitleaks version (use 'latest' or a tag like v8.19.0)"
        required: false
        default: "latest"

concurrency:
  group: trivy-and-ml-${{ github.event.pull_request.number || github.ref }}-${{ github.event.inputs.mode || 'pipeline' }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  pull-requests: write

jobs:
  trivy_eval_and_ml:
    # Run on push/PR as usual. If manually triggered, run only when mode == pipeline
    if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.mode == 'pipeline' }}
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.12'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Git LFS Pull
        run: git lfs pull

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python deps (ML only)
        run: |
          if [ -f ml/requirements.txt ]; then pip install -r ml/requirements.txt; fi

      - name: Prepare dirs
        run: |
          rm -rf datasets trivy_out artifacts ml_out validation
          mkdir -p datasets trivy_out artifacts ml_out validation
          echo "Cleaned and recreated output directories"

      - name: Generate payment set
        env:
          INJECT_PROFILE: medium
        run: |
          python trivy/make_payment_set_trivy.py --id 0001 --template trivy/payment_set_template
          echo "Generated -> datasets/payment_set_0001"

      - name: Install Trivy (official script)
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          ./bin/trivy --version

      - name: Trivy filesystem scan (JSON for scoring)
        run: |
          ./bin/trivy fs --scanners secret \
            --format json -o trivy_out/scan.json datasets/payment_set_0001 || true

      - name: Score Trivy (Precision/Recall/F1 + risk -> JSON)
        run: |
          python trivy/score_trivy.py \
            --scan trivy_out/scan.json \
            --gt-csv datasets/payment_set_0001/ground_truth/secrets.csv \
            --out trivy_out/trivy_metrics.json

          echo "Trivy metrics (compact display)"
          cat trivy_out/trivy_metrics.json | jq '{
            risk: .risk,
            critical: .critical,
            TP: .TP,
            FP: .FP,
            FN: .FN,
            precision: .precision,
            recall: .recall,
            f1: .f1
          }'

      - name: Verify Isolation Forest model exists
        run: |
          test -f ml/models/isolation_forest_model_v1.pkl || (echo "Model not found: ml/models/isolation_forest_model_v1.pkl. Run ml/src/train.py and commit the .pkl."; exit 1)

      - name: ML Evaluate (Isolation Forest on eval.csv)
        env:
          ML_DECISION_MODE: bestf1
          ML_CONTAM: "0.05"
        run: |
          python ml/src/evaluate.py
          echo "ML metrics"
          cat ml_out/ml_metrics.json

      - name: Decision Gate (compare Trivy + ML)
        run: |
          python ml/src/decision_gate.py
          echo "Gate output"
          cat ml_out/gate_out.json

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-and-ml-artifacts
          path: |
            artifacts/**
            trivy_out/**
            ml_out/**

      - name: Post Job Summary
        if: always()
        run: |
          {
            echo "## Trivy + ML Summary"
            echo

            echo "### Trivy Metrics"
            if [ -f trivy_out/trivy_metrics.json ]; then
              echo '```json'
              cat trivy_out/trivy_metrics.json | jq '{
                risk: .risk,
                critical: .critical,
                TP: .TP,
                FP: .FP,
                FN: .FN,
                precision: .precision,
                recall: .recall,
                f1: .f1
              }'
              echo '```'
            else
              echo "_trivy_out/trivy_metrics.json not found_"
            fi

            echo
            echo "### ML Metrics"
            if [ -f ml_out/ml_metrics.json ]; then
              echo '```json'
              cat ml_out/ml_metrics.json
              echo '```'
            else
              echo "_ml_out/ml_metrics.json not found_"
            fi

            echo
            echo "### Decision Gate"
            if [ -f ml_out/gate_out.json ]; then
              echo '```json'
              cat ml_out/gate_out.json
              echo '```'
            else
              echo "_ml_out/gate_out.json not found_"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  sv_trivy_validation:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'sv_trivy' }}
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.12'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Trivy (official script) and add to PATH
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          ./bin/trivy --version
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: Prepare dirs for SV runs
        run: |
          rm -rf datasets validation/trivy_runs validation/summary
          mkdir -p datasets validation/trivy_runs validation/summary

      - name: Run SV trials (low/medium/high) + summarize
        run: |
          RUNS="${{ github.event.inputs.runs }}"
          PROFILES="${{ github.event.inputs.profiles }}"
          python validation/run_trivy_trials.py --runs "${RUNS:-10}" --profiles "${PROFILES:-low,medium,high}"
          python validation/summarize_trivy.py

      - name: Upload SV summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: sv-trivy-summary
          path: |
            validation/summary/trivy_summary.csv
            validation/summary/trivy_runs_detailed.csv

  sv_ml_validation:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'sv_ml' }}
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.12'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Git LFS Pull
        run: git lfs pull

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python deps (ML)
        run: |
          if [ -f ml/requirements.txt ]; then pip install -r ml/requirements.txt; fi
          python -c "import pandas, numpy, sklearn" || pip install pandas numpy scikit-learn

      - name: Prepare dirs for ML validation
        run: |
          rm -rf validation/ml_runs validation/summary
          mkdir -p validation/ml_runs validation/summary

      - name: Run ML K-fold cross-validation + summarize
        run: |
          FOLDS="${{ github.event.inputs.ml_folds }}"
          SEEDS="${{ github.event.inputs.ml_seeds }}"
          CONTAM="${{ github.event.inputs.ml_contam }}"
          python validation/run_ml_cv_trials.py --folds "${FOLDS:-5}" --seeds "${SEEDS:-42,43,44}" --contam "${CONTAM:-0.05}"
          python validation/summarize_ml.py
          ls -R validation || true

      - name: Upload ML validation artifact
        uses: actions/upload-artifact@v4
        with:
          name: sv-ml-validation
          path: |
            validation/ml_runs/ml_runs_detailed.csv
            validation/summary/ml_summary.csv
            validation/summary/ml_by_seed.csv

  sv_gate_validation:
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'sv_gate' }}
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.12'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Git LFS Pull
        run: git lfs pull

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python deps (ML)
        run: |
          if [ -f ml/requirements.txt ]; then pip install -r ml/requirements.txt; fi
          python -c "import pandas, numpy, sklearn" || pip install pandas numpy scikit-learn

      - name: Install Trivy (official script) and add to PATH
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          ./bin/trivy --version
          echo "$PWD/bin" >> $GITHUB_PATH

      - name: Prepare dirs for Gate validation
        run: |
          rm -rf validation/gate_runs validation/summary datasets trivy_out ml_out artifacts
          mkdir -p validation/gate_runs validation/summary

      - name: Run Hybrid Gate trials + summarize
        run: |
          RUNS="${{ github.event.inputs.gate_runs }}"
          PROFILES="${{ github.event.inputs.gate_profiles }}"
          CONTAM="${{ github.event.inputs.gate_ml_contam }}"
          python validation/run_gate_trials.py --runs "${RUNS:-10}" --profiles "${PROFILES:-clean,low,medium,high}" --ml_contam "${CONTAM:-0.005}"
          python validation/summarize_gate.py
          ls -R validation || true

      - name: Upload Hybrid Gate validation artifact
        uses: actions/upload-artifact@v4
        with:
          name: sv-gate-validation
          path: |
            validation/gate_runs/**
            validation/summary/**

  sv_gitleaks_validation:
    # Manual-only job: Gitleaks evaluation against the SAME injected profiles + ground truth
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'sv_gitleaks' }}
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.12'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Gitleaks (binary)
        run: |
          set -e
          mkdir -p bin
          VERSION="${{ github.event.inputs.gitleaks_version }}"
          if [ -z "$VERSION" ] || [ "$VERSION" = "latest" ]; then
            VERSION=$(curl -sL https://api.github.com/repos/gitleaks/gitleaks/releases/latest | jq -r '.tag_name')
          else
            # normalize
            VERSION="v${VERSION#v}"
          fi
          echo "Using gitleaks version: $VERSION"
          ARCHIVE="gitleaks_${VERSION#v}_linux_x64.tar.gz"
          curl -sL "https://github.com/gitleaks/gitleaks/releases/download/${VERSION}/${ARCHIVE}" -o /tmp/gitleaks.tgz
          tar -xzf /tmp/gitleaks.tgz -C ./bin gitleaks
          chmod +x ./bin/gitleaks
          echo "$PWD/bin" >> $GITHUB_PATH
          gitleaks version

      - name: Prepare dirs for Gitleaks SV runs
        run: |
          rm -rf datasets validation/gitleaks_runs validation/summary
          mkdir -p datasets validation/gitleaks_runs validation/summary

      - name: Run Gitleaks trials (clean/low/medium/high) + summarize
        run: |
          set -e

          RUNS="${{ github.event.inputs.gitleaks_runs }}"
          PROFILES="${{ github.event.inputs.gitleaks_profiles }}"

          DETAIL_CSV="validation/summary/gitleaks_runs_detailed.csv"
          SUMMARY_CSV="validation/summary/gitleaks_summary.csv"

          echo "profile,run,tp,fp,fn,precision,recall,f1,found_count,gt_count" > "$DETAIL_CSV"

          IFS=',' read -ra P_ARR <<< "$PROFILES"
          for profile in "${P_ARR[@]}"; do
            profile="$(echo "$profile" | xargs)" # trim
            for i in $(seq 1 "${RUNS:-10}"); do
              RUN_ID=$(printf "%02d" "$i")
              echo ">>> Gitleaks profile=$profile run=$RUN_ID"

              rm -rf datasets/payment_set_0001 || true

              INJECT_PROFILE="$profile" python trivy/make_payment_set_trivy.py --id 0001 --template trivy/payment_set_template

              REPORT="validation/gitleaks_runs/${profile}_run_${RUN_ID}.json"
              gitleaks detect --no-git --source datasets/payment_set_0001 --report-format json --report-path "$REPORT" --redact || true

              python - <<'PY'
import csv, json, os, sys

profile = os.environ["PROFILE"]
run_id = os.environ["RUN_ID"]
report_path = os.environ["REPORT"]
gt_csv = "datasets/payment_set_0001/ground_truth/secrets.csv"
out_csv = os.environ["DETAIL_CSV"]

def norm_path(p: str) -> str:
    p = (p or "").replace("\\", "/")
    if "datasets/payment_set_0001/" in p:
        p = p.split("datasets/payment_set_0001/")[-1]
    if p.startswith("/"):
        # best-effort: keep filename + last folder
        parts = p.strip("/").split("/")
        if len(parts) >= 2:
            p = "/".join(parts[-2:])
        else:
            p = parts[-1] if parts else ""
    return p

def norm_type(s: str) -> str:
    s = (s or "").lower()
    if "aws" in s and "access" in s:
        return "aws_access_key_id"
    if "aws" in s and "secret" in s:
        return "aws_secret_access_key"
    if "postgres" in s or "connection" in s:
        return "postgres_uri"
    if "jwt" in s:
        return "dummy_jwt"
    if "stripe" in s or "api" in s or "generic" in s:
        return "generic_api_key"
    return s or "unknown"

# load GT
gt = set()
with open(gt_csv, newline="") as f:
    for r in csv.DictReader(f):
        gt.add((norm_path(r.get("file_path","")), norm_type(r.get("secret_type",""))))

# load gitleaks findings
found = set()
if os.path.exists(report_path) and os.path.getsize(report_path) > 0:
    try:
        data = json.load(open(report_path, "r", encoding="utf-8"))
        if isinstance(data, dict) and "leaks" in data:
            data = data["leaks"]
        if isinstance(data, list):
            for leak in data:
                fp = norm_path(leak.get("File") or leak.get("FilePath") or "")
                rid = leak.get("RuleID") or leak.get("Rule") or leak.get("Description") or ""
                found.add((fp, norm_type(rid)))
    except Exception:
        pass

TP = len(found & gt)
FP = len(found - gt)
FN = len(gt - found)

prec = TP / (TP + FP) if (TP + FP) else 0.0
rec  = TP / (TP + FN) if (TP + FN) else 0.0
f1   = (2*prec*rec/(prec+rec)) if (prec+rec) else 0.0

row = [profile, run_id, TP, FP, FN, round(prec,6), round(rec,6), round(f1,6), len(found), len(gt)]

with open(out_csv, "a", newline="") as f:
    f.write(",".join(map(str,row)) + "\n")
PY
              PROFILE="$profile" RUN_ID="$RUN_ID" REPORT="$REPORT" DETAIL_CSV="$DETAIL_CSV" python -c "pass" >/dev/null

            done
          done

          python - <<'PY'
import pandas as pd
df = pd.read_csv("validation/summary/gitleaks_runs_detailed.csv")
summary = df.groupby("profile")[["precision","recall","f1","tp","fp","fn","found_count","gt_count"]].mean().reset_index()
summary.to_csv("validation/summary/gitleaks_summary.csv", index=False)
print(summary)
PY

      - name: Upload Gitleaks SV summary artifact
        uses: actions/upload-artifact@v4
        with:
          name: sv-gitleaks-summary
          path: |
            validation/gitleaks_runs/**
            validation/summary/gitleaks_runs_detailed.csv
            validation/summary/gitleaks_summary.csv
