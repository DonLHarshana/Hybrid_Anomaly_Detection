name: trivy-and-ml

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: trivy-and-ml-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  pull-requests: write

jobs:
  trivy_eval_and_ml:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.11'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python deps (ML only)
        run: |
          if [ -f ml/requirements.txt ]; then pip install -r ml/requirements.txt; fi

      - name: Prepare dirs
        run: mkdir -p datasets trivy_out artifacts ml_out

      # ------------------- DATA GENERATION -------------------
      - name: Generate payment set
        run: |
          python trivy/make_payment_set_trivy.py --id 0001 --template trivy/payment_set_template
          echo "Generated -> datasets/payment_set_0001"

      - name: Show generated tree (debug)
        run: ls -R datasets/payment_set_0001

      # ------------------- TRIVY -------------------
      - name: Install Trivy (official script)
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          ./bin/trivy --version

      - name: Trivy filesystem scan (JSON for scoring)
        run: |
          ./bin/trivy fs --scanners secret,misconfig --format json -o trivy_out/scan.json datasets/payment_set_0001 || true

      - name: Trivy filesystem scan (SARIF artifact)
        run: |
          ./bin/trivy fs --scanners secret,misconfig --format sarif -o artifacts/0001_trivy.sarif datasets/payment_set_0001 || true

      # ------------------- SCORE TRIVY -> JSON -------------------
      - name: Score Trivy (Precision/Recall/F1 + risk -> JSON)
        run: |
          python trivy/score_trivy.py --scan trivy_out/scan.json --out trivy_out/trivy_metrics.json
          echo "----- Trivy metrics -----"
          cat trivy_out/trivy_metrics.json

      # ------------------- ML -------------------
      - name: Verify Isolation Forest model exists
        run: |
          test -f ml/models/isolation_forest_model_v1.pkl || (echo "Model not found: ml/models/isolation_forest_model_v1.pkl. Run ml/src/train.py and commit the .pkl."; exit 1)

      - name: ML Evaluate (Isolation Forest on eval.csv)
        run: |
          python ml/src/evaluate.py
          echo "----- ML metrics -----"
          cat ml_out/ml_metrics.json

      - name: Decision Gate (compare Trivy + ML)
        run: |
          python ml/src/decision_gate.py

      # ------------------- ARTIFACTS + SUMMARY -------------------
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-and-ml-artifacts
          path: |
            artifacts/**
            trivy_out/**
            ml_out/**

      - name: Post Job Summary
        if: always()
        run: |
          {
            echo "## Trivy + ML Summary"
            echo

            echo "### Trivy metrics"
            if [ -f trivy_out/trivy_metrics.json ]; then
              echo '```json'; cat trivy_out/trivy_metrics.json; echo '```'
            else
              echo "_trivy_out/trivy_metrics.json not found_"
            fi

            echo
            echo "### ML metrics"
            if [ -f ml_out/ml_metrics.json ]; then
              echo '```json'; cat ml_out/ml_metrics.json; echo '```'
            else
              echo "_ml_out/ml_metrics.json not found_"
            fi

            echo
            echo "### Decision"
            if [ -f ml_out/gate_out.json ]; then
              echo '```json'; cat ml_out/gate_out.json; echo '```'
            else
              echo "_ml_out/gate_out.json not found_"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # =================== GRAFANA CLOUD via OTLP gRPC ===================

      # Derive host from OTEL_ENDPOINT (e.g., https://otlp-gateway-STACK.grafana.net/otlp -> otlp-gateway-STACK.grafana.net)
      - name: Derive OTLP host/endpoint for gRPC
        id: otlp
        env:
          RAW_ENDPOINT: ${{ vars.OTEL_ENDPOINT }}
        run: |
          set -e
          # Remove the port if it already exists
          HOST=$(echo "$RAW_ENDPOINT" | sed -E 's#^https?://##; s#(:[0-9]+)#\1#')
          echo "host=$HOST" >> "$GITHUB_OUTPUT"
          echo "grpc=https://$HOST:443" >> "$GITHUB_OUTPUT"  # Ensure gRPC endpoint is correctly formed
          echo "Derived host: $HOST"
          echo "Derived gRPC endpoint: https://$HOST:443"



      # Push actual Trivy/ML metrics via OTLP gRPC (no telemetrygen step)
      - name: Push demo metrics via OTLP gRPC (telemetrygen)
        if: ${{ vars.OTEL_ENDPOINT != '' && vars.OTEL_HEADERS != '' }}
        env:
          SERVICE_NAME: trivy-ml-ci
          OTEL_HEADERS: ${{ vars.OTEL_HEADERS }}   # Authorization=Bearer ...
        run: |
          set -e
          docker pull ghcr.io/open-telemetry/opentelemetry-collector-contrib/telemetrygen:latest
          KEY="${OTEL_HEADERS%%=*}"
          VAL="${OTEL_HEADERS#*=}"
          HDR=${KEY}=\"${VAL}\"
          docker run --rm ghcr.io/open-telemetry/opentelemetry-collector-contrib/telemetrygen:latest \
            metrics --duration 8s --rate 2 \
            --service "${SERVICE_NAME}" \
            --otlp-endpoint "${{ steps.otlp.outputs.grpc }}" \
            --otlp-header "${HDR}" \
            --otlp-attributes "deployment.environment=\"ci\"" \
            --otlp-attributes "service.namespace=\"github\""


      # Install OTLP Python libs (include gRPC exporter)
      - name: Install OTLP libs (Python gRPC)
        run: |
          pip install --upgrade \
            "opentelemetry-sdk>=1.25.0" \
            "opentelemetry-api>=1.25.0" \
            "opentelemetry-exporter-otlp-proto-grpc>=1.25.0"

      # Push actual metrics from Trivy/ML via Python to Grafana Cloud using OTLP gRPC
      - name: Push actual metrics to Grafana Cloud via OTLP gRPC (Python sender)
        if: ${{ vars.OTEL_ENDPOINT != '' && vars.OTEL_HEADERS != '' }}
        env:
          SERVICE_NAME: trivy-ml-ci
          OTEL_HEADERS: ${{ vars.OTEL_HEADERS }}   # Authorization=Bearer ...
        run: |
          python scripts/push_to_grafana.py
