name: trivy-and-ml

on:
  push:
    branches: [ main, hybrid_operator ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: trivy-and-ml-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  pull-requests: write

jobs:
  trivy_eval_and_ml:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.11'
      # OTLP config from VARIABLES only
      OTEL_EXPORTER_OTLP_ENDPOINT: ${{ vars.OTEL_ENDPOINT }}   # e.g. https://otlp-gateway-.../otlp
      OTEL_EXPORTER_OTLP_PROTOCOL: ${{ vars.OTEL_PROTOCOL }}   # http/protobuf
      OTEL_EXPORTER_OTLP_HEADERS:  ${{ vars.OTEL_HEADERS }}    # Authorization=Bearer <token> OR Authorization=Basic <...>

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python deps (ML + OTLP)
        run: |
          pip install --upgrade pip
          if [ -f ml/requirements.txt ]; then pip install -r ml/requirements.txt; fi
          # OpenTelemetry SDK + OTLP HTTP exporter
          pip install "opentelemetry-sdk>=1.25.0" "opentelemetry-exporter-otlp>=1.25.0" "opentelemetry-api>=1.25.0" jq

      - name: Prepare dirs
        run: mkdir -p datasets trivy_out artifacts ml_out

      # ------------------- DATA GENERATION -------------------
      - name: Generate payment set
        run: |
          python trivy/make_payment_set_trivy.py --id 0001 --template trivy/payment_set_template
          echo "Generated -> datasets/payment_set_0001"

      # ------------------- TRIVY -------------------
      - name: Install Trivy (official script)
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          ./bin/trivy --version

      - name: Trivy filesystem scan (JSON for scoring)
        run: |
          ./bin/trivy fs --scanners secret,misconfig \
            --format json -o trivy_out/scan.json datasets/payment_set_0001 || true

      - name: Trivy filesystem scan (SARIF artifact)
        run: |
          ./bin/trivy fs --scanners secret,misconfig \
            --format sarif -o artifacts/0001_trivy.sarif datasets/payment_set_0001 || true

      # ------------------- SCORE TRIVY -> JSON -------------------
      - name: Score Trivy (Precision/Recall/F1 + risk -> JSON)
        run: |
          python trivy/score_trivy.py --scan trivy_out/scan.json --out trivy_out/trivy_metrics.json
          echo "----- Trivy metrics -----"
          cat trivy_out/trivy_metrics.json

      # ------------------- ML -------------------
      - name: Verify Isolation Forest model exists
        run: |
          test -f ml/models/isolation_forest_model_v1.pkl || (echo "Model not found: ml/models/isolation_forest_model_v1.pkl. Run ml/src/train.py and commit the .pkl."; exit 1)

      - name: ML Evaluate (Isolation Forest on eval.csv)
        run: |
          python ml/src/evaluate.py
          echo "----- ML metrics -----"
          cat ml_out/ml_metrics.json

      - name: Decision Gate (compare Trivy + ML)
        run: |
          python ml/src/decision_gate.py

      # ------------------- ARTIFACTS + SUMMARY -------------------
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-and-ml-artifacts
          path: |
            artifacts/**
            trivy_out/**
            ml_out/**

      - name: Post Job Summary
        if: always()
        run: |
          {
            echo "## Trivy + ML Summary"
            echo
            echo "### Trivy metrics"
            if [ -f trivy_out/trivy_metrics.json ]; then
              echo '```json'; cat trivy_out/trivy_metrics.json; echo '```'
            else
              echo "_trivy_out/trivy_metrics.json not found_"
            fi
            echo
            echo "### ML metrics"
            if [ -f ml_out/ml_metrics.json ]; then
              echo '```json'; cat ml_out/ml_metrics.json; echo '```'
            else
              echo "_ml_out/ml_metrics.json not found_"
            fi
            echo
            echo "### Decision"
            if [ -f ml_out/gate_out.json ]; then
              echo '```json'; cat ml_out/gate_out.json; echo '```'
            else
              echo "_ml_out/gate_out.json not found_"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # ------------------- Grafana Cloud (OTLP via Python) -------------------
      - name: Extract metrics and push to Grafana Cloud (OTLP)
        if: ${{ success() && env.OTEL_EXPORTER_OTLP_HEADERS != '' && env.OTEL_EXPORTER_OTLP_ENDPOINT != '' }}
        env:
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          RUN_ID: ${{ github.run_id }}
          COMMIT: ${{ github.sha }}
        shell: bash
        run: |
          set -euo pipefail

          # ---- Extract values with jq (safe even if keys missing)
          jqs()   { jq -r "$1" "$2" 2>/dev/null || echo 0; }
          jqlen() { jq    "$1" "$2" 2>/dev/null || echo 0; }

          CRIT=$(jqlen '[.Results[]?.Vulnerabilities[]? | select((.Severity // "") | ascii_upcase == "CRITICAL")] | length' trivy_out/scan.json)
          HIGH=$(jqlen '[.Results[]?.Vulnerabilities[]? | select((.Severity // "") | ascii_upcase == "HIGH")]     | length' trivy_out/scan.json)
          MED=$(jqlen  '[.Results[]?.Vulnerabilities[]? | select((.Severity // "") | ascii_upcase == "MEDIUM")]   | length' trivy_out/scan.json)
          LOW=$(jqlen  '[.Results[]?.Vulnerabilities[]? | select((.Severity // "") | ascii_upcase == "LOW")]      | length' trivy_out/scan.json)

          MIS=$(jqlen  '[.Results[]?.Misconfigurations[]?] | length' trivy_out/scan.json)
          SECR=$(jqlen '[.Results[]?.Secrets[]?]           | length' trivy_out/scan.json)

          PREC=$(jqs '.precision // 0'          ml_out/ml_metrics.json)
          REC=$(jqs  '.recall // 0'             ml_out/ml_metrics.json)
          F1=$(jqs   '.f1 // 0'                 ml_out/ml_metrics.json)
          ANOM=$(jqs '.anomalies_detected // 0' ml_out/ml_metrics.json)

          APPROVE=$(jqs '.approve // .APPROVE // 0' ml_out/gate_out.json)
          HOLD=$(jqs    '.hold    // .HOLD    // 0' ml_out/gate_out.json)
          BLOCK=$(jqs   '.block   // .BLOCK   // 0' ml_out/gate_out.json)

          # ---- Run a Python OTLP sender (single-shot export)
          python - <<'PY'
import os, time
from opentelemetry.metrics import get_meter
from opentelemetry.sdk.resources import Resource
from opentelemetry.sdk.metrics import MeterProvider
from opentelemetry.sdk.metrics.export import PeriodicExportingMetricReader
from opentelemetry.exporter.otlp.proto.http.metric_exporter import OTLPMetricExporter

repo   = os.environ.get("REPO","unknown")
branch = os.environ.get("BRANCH","unknown")

# Exporter is configured by env: OTEL_EXPORTER_OTLP_ENDPOINT/PROTOCOL/HEADERS
exporter = OTLPMetricExporter()  # uses env for endpoint, headers, protocol
reader   = PeriodicExportingMetricReader(exporter, export_interval_millis=1000)
provider = MeterProvider(resource=Resource.create({"service.name": "trivy-ml-ci", "repo": repo, "branch": branch}),
                         metric_readers=[reader])
from opentelemetry.metrics import set_meter_provider
set_meter_provider(provider)
meter = get_meter("ci.trivy_ml")

# Counters (sums)
sev = meter.create_counter("trivy_severity_count")
findings = meter.create_counter("trivy_findings_total")
gate = meter.create_counter("decision_gate_events_total")
anom = meter.create_counter("ml_anomalies_detected_total")

# Gauges (record as up/down counter alternatives; or use observable gauge if preferred)
prec = meter.create_up_down_counter("ml_precision")
rec  = meter.create_up_down_counter("ml_recall")
f1   = meter.create_up_down_counter("ml_f1_score")

# Pull values from env (set in bash above)
def getenv_num(name, default=0.0):
    try:
        return float(os.environ.get(name, default))
    except Exception:
        return float(default)

CRIT = getenv_num("CRIT"); HIGH = getenv_num("HIGH"); MED = getenv_num("MED"); LOW = getenv_num("LOW")
MIS  = getenv_num("MIS");  SECR = getenv_num("SECR")
PREC = getenv_num("PREC"); REC  = getenv_num("REC"); F1   = getenv_num("F1")
ANOM = getenv_num("ANOM")
APPROVE = getenv_num("APPROVE"); HOLD = getenv_num("HOLD"); BLOCK = getenv_num("BLOCK")

# Emit
sev.add(int(CRIT),  {"severity":"CRITICAL","repo":repo,"branch":branch})
sev.add(int(HIGH),  {"severity":"HIGH","repo":repo,"branch":branch})
sev.add(int(MED),   {"severity":"MEDIUM","repo":repo,"branch":branch})
sev.add(int(LOW),   {"severity":"LOW","repo":repo,"branch":branch})

findings.add(int(MIS),  {"type":"misconfig","repo":repo,"branch":branch})
findings.add(int(SECR), {"type":"secret","repo":repo,"branch":branch})

anom.add(int(ANOM), {"repo":repo,"branch":branch})

gate.add(int(APPROVE), {"action":"APPROVE","repo":repo,"branch":branch})
gate.add(int(HOLD),    {"action":"HOLD","repo":repo,"branch":branch})
gate.add(int(BLOCK),   {"action":"BLOCK","repo":repo,"branch":branch})

# Record gauges as deltas (works fine for single-shot export)
prec.add(PREC, {"repo":repo,"branch":branch})
rec.add(REC,   {"repo":repo,"branch":branch})
f1.add(F1,     {"repo":repo,"branch":branch})

# Give the reader a moment to export
time.sleep(2)
PY
