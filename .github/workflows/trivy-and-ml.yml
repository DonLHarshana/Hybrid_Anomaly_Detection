name: trivy-and-ml

on:
  push:
    branches: [ main, hybrid_operator ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: trivy-and-ml-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  pull-requests: write

jobs:
  trivy_eval_and_ml:
    runs-on: ubuntu-latest
    env:
      PYTHON_VERSION: '3.11'
      # map OTLP secrets to env so we can check them in `if:` if needed
      OTEL_EXPORTER_OTLP_ENDPOINT: ${{ secrets.OTEL_ENDPOINT }}
      OTEL_EXPORTER_OTLP_HEADERS:  ${{ secrets.OTEL_HEADERS }}
      OTEL_EXPORTER_OTLP_PROTOCOL: ${{ secrets.OTEL_PROTOCOL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python deps (ML only)
        run: |
          if [ -f ml/requirements.txt ]; then pip install -r ml/requirements.txt; fi

      - name: Prepare dirs
        run: mkdir -p datasets trivy_out artifacts

      - name: Generate payment set + ground truth
        run: |
          python trivy/secrets_injector.py \
            --template trivy/payment_set_template \
            --out datasets/payment_set_0001 \
            --gt datasets/payment_set_0001/ground_truth/secrets.csv \
            --extra-per-file 3

      - name: Install Trivy (official script)
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh
          ./bin/trivy --version

      - name: Trivy filesystem scan (JSON for scoring)
        run: |
          ./bin/trivy fs --scanners vuln,config,secret \
            --format json -o trivy_out/scan.json datasets/payment_set_0001 || true

      - name: Trivy filesystem scan (SARIF artifact)
        run: |
          ./bin/trivy fs --scanners vuln,config,secret \
            --format sarif -o artifacts/0001_trivy.sarif datasets/payment_set_0001 || true

      - name: Score Trivy (Precision/Recall/F1 + risk -> JSON)
        run: |
          python trivy/score_trivy.py \
            --scan trivy_out/scan.json \
            --out trivy_out/trivy_metrics.json \
            --gt-secrets datasets/payment_set_0001/ground_truth/secrets.csv
          echo "----- Trivy metrics -----"
          cat trivy_out/trivy_metrics.json

      - name: Verify Isolation Forest model exists
        run: |
          test -f ml/models/isolation_forest_model_v1.pkl || (echo "Model not found: ml/models/isolation_forest_model_v1.pkl. Run ml/src/train.py and commit the .pkl."; exit 1)

      - name: ML Evaluate (Isolation Forest on eval.csv)
        run: |
          python ml/src/evaluate.py
          echo "----- ML metrics -----"
          cat ml_out/ml_metrics.json

      - name: Decision Gate (compare Trivy + ML)
        env:
          FAIL_ON: NONE
        run: |
          python ml/src/decision_gate.py
        continue-on-error: true

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-and-ml-artifacts
          path: |
            artifacts/**
            trivy_out/**
            ml_out/**

      - name: Post Job Summary
        if: always()
        run: |
          {
            echo "## Trivy + ML Summary"
            echo
            echo "### Trivy metrics"
            if [ -f trivy_out/trivy_metrics.json ]; then
              echo '```json'; cat trivy_out/trivy_metrics.json; echo '```'
            else
              echo "_trivy_out/trivy_metrics.json not found_"
            fi
            echo
            echo "### ML metrics"
            if [ -f ml_out/ml_metrics.json ]; then
              echo '```json'; cat ml_out/ml_metrics.json; echo '```'
            else
              echo "_ml_out/ml_metrics.json not found_"
            fi
            echo
            echo "### Decision"
            if [ -f ml_out/gate_out.json ]; then
              echo '```json'; cat ml_out/gate_out.json; echo '```'
            else
              echo "_ml_out/gate_out.json not found_"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # ------------------------------ Grafana (OTLP) ------------------------------
      - name: Install otel-cli
        run: |
          curl -sSL https://github.com/equinix-labs/otel-cli/releases/latest/download/otel-cli_amd64.deb -o /tmp/otel-cli.deb
          sudo dpkg -i /tmp/otel-cli.deb
          otel-cli version

      - name: Push Trivy + ML metrics to Grafana Cloud (OTLP)
        # Skip if secrets aren't available (e.g., forked PRs)
        if: ${{ always() && env.OTEL_EXPORTER_OTLP_HEADERS != '' && env.OTEL_EXPORTER_OTLP_ENDPOINT != '' }}
        shell: bash
        env:
          REPO:   ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          RUN_ID: ${{ github.run_id }}
          COMMIT: ${{ github.sha }}
        run: |
          set -euo pipefail
          sudo apt-get update -y && sudo apt-get install -y jq

          # helpers
          jqs()   { jq -r "$1" "$2" 2>/dev/null || echo 0; }
          jqlen() { jq "$1" "$2"   2>/dev/null || echo 0; }

          # From scan.json (note: vuln severities may be 0 if only secret scan finds stuff)
          CRIT=$(jqlen '[.Results[]?.Vulnerabilities[]? | select((.Severity // "") | ascii_upcase == "CRITICAL")] | length' trivy_out/scan.json)
          HIGH=$(jqlen '[.Results[]?.Vulnerabilities[]? | select((.Severity // "") | ascii_upcase == "HIGH")]     | length' trivy_out/scan.json)
          MED=$(jqlen  '[.Results[]?.Vulnerabilities[]? | select((.Severity // "") | ascii_upcase == "MEDIUM")]   | length' trivy_out/scan.json)
          LOW=$(jqlen  '[.Results[]?.Vulnerabilities[]? | select((.Severity // "") | ascii_upcase == "LOW")]      | length' trivy_out/scan.json)

          MIS=$(jqlen  '[.Results[]?.Misconfigurations[]?] | length' trivy_out/scan.json)
          SECR=$(jqlen '[.Results[]?.Secrets[]?]           | length' trivy_out/scan.json)

          # ML metrics (FIX: read only ml_out/ml_metrics.json)
          PREC=$(jqs '.precision // 0'          ml_out/ml_metrics.json)
          REC=$(jqs  '.recall // 0'             ml_out/ml_metrics.json)
          F1=$(jqs   '.f1 // 0'                 ml_out/ml_metrics.json)
          ANOM=$(jqs '.anomalies_detected // 0' ml_out/ml_metrics.json)

          # Decision gate
          APPROVE=$(jqs '.approve // .APPROVE // 0' ml_out/gate_out.json)
          HOLD=$(jqs    '.hold    // .HOLD    // 0' ml_out/gate_out.json)
          BLOCK=$(jqs   '.block   // .BLOCK   // 0' ml_out/gate_out.json)

          # Emit OTLP metrics (attributes -> labels)
          otel-cli metric --name trivy_severity_count --sum --value "$CRIT" --attributes "severity=CRITICAL,repo=$REPO,branch=$BRANCH"
          otel-cli metric --name trivy_severity_count --sum --value "$HIGH" --attributes "severity=HIGH,repo=$REPO,branch=$BRANCH"
          otel-cli metric --name trivy_severity_count --sum --value "$MED"  --attributes "severity=MEDIUM,repo=$REPO,branch=$BRANCH"
          otel-cli metric --name trivy_severity_count --sum --value "$LOW"  --attributes "severity=LOW,repo=$REPO,branch=$BRANCH"

          otel-cli metric --name trivy_findings_total --sum --value "$MIS"  --attributes "type=misconfig,repo=$REPO,branch=$BRANCH"
          otel-cli metric --name trivy_findings_total --sum --value "$SECR" --attributes "type=secret,repo=$REPO,branch=$BRANCH"

          otel-cli metric --name ml_precision --gauge --value "$PREC" --attributes "repo=$REPO,branch=$BRANCH"
          otel-cli metric --name ml_recall    --gauge --value "$REC"  --attributes "repo=$REPO,branch=$BRANCH"
          otel-cli metric --name ml_f1_score  --gauge --value "$F1"   --attributes "repo=$REPO,branch=$BRANCH"
          otel-cli metric --name ml_anomalies_detected_total --sum --value "$ANOM" --attributes "repo=$REPO,branch=$BRANCH"

          otel-cli metric --name decision_gate_events_total --sum --value "$APPROVE" --attributes "action=APPROVE,repo=$REPO,branch=$BRANCH"
          otel-cli metric --name decision_gate_events_total --sum --value "$HOLD"    --attributes "action=HOLD,repo=$REPO,branch=$BRANCH"
          otel-cli metric --name decision_gate_events_total --sum --value "$BLOCK"   --attributes "action=BLOCK,repo=$REPO,branch=$BRANCH"
